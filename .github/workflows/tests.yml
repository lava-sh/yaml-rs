name: tests

on:
  workflow_call:

jobs:
  tests:
    name: "${{ matrix.os }} / python ${{ matrix.python-version }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.13t"
          - "3.14"
          - "3.14t"
          - "pypy3.11"
        os: [
          ubuntu-latest,
          windows-latest,
        ]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ matrix.python-version }}
      - name: "Install uv"
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: ${{ !startsWith(github.ref, 'refs/tags/') }} # zizmor: ignore[cache-poisoning]
      - name: "Create and activate .venv"
        shell: bash
        run: |
          uv venv .venv --python ${{ matrix.python-version }}
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo ".venv/Scripts" >> "$GITHUB_PATH"
            echo "PYO3_PYTHON=.venv/Scripts/python" >> "$GITHUB_ENV"
          else
            echo ".venv/bin" >> "$GITHUB_PATH"
            echo "PYO3_PYTHON=.venv/bin/python3" >> "$GITHUB_ENV"
          fi
      - name: "Install dependencies"
        run: |
          uv pip install --group ci
      - name: "Run maturin (--release)"
        run: |
          rustc --version --verbose
          maturin develop --release --features mimalloc
      - name: "Run Ruff"
        run: |
          ruff check
      - name: "Run pytest"
        run: |
          pytest tests/
