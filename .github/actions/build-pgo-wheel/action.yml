# https://github.com/pydantic/pydantic-core/blob/main/.github/actions/build-pgo-wheel/action.yml
# ignored most zizmor lints
name: Build PGO wheel
description: Builds a PGO-optimized wheel
inputs:
  interpreter:
    description: "Interpreter to build the wheel for"
    required: true
  rust-toolchain:
    description: "Rust toolchain to use"
    required: true
outputs:
  wheel:
    description: "Path to the built wheel"
    value: ${{ steps.find_wheel.outputs.path }}
runs:
  using: "composite"
  steps:
    - name: "Prepare profiling directory"
      shell: bash
      # making this ahead of to compile ensures that the local user can write to this
      # directory; the maturin action (on linux) runs in docker so would create as root
      run: mkdir -p ${{ github.workspace }}/profdata

    - name: "Build initial wheel"
      uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
      with:
        manylinux: auto
        args: >
          --release
          --out pgo-wheel
          --interpreter ${{ inputs.interpreter }}
        rust-toolchain: ${{ inputs.rust-toolchain }}
        docker-options: -e CI
      env:
        RUSTFLAGS: "-Cprofile-generate=${{ github.workspace }}/profdata"

    - name: "Detect rust host"
      run: echo RUST_HOST=$(rustc -Vv | grep host | cut -d ' ' -f 2) >> "$GITHUB_ENV" # zizmor: ignore[github-env]
      shell: bash

    - name: "Generate pgo data"
      run: |
        uv sync --group dev
        uv pip install yaml-rs --no-index --no-deps --find-links pgo-wheel --force-reinstall
        uv run pytest tests/
        RUST_HOST=$(rustc -Vv | grep host | cut -d ' ' -f 2)
        rustup run "${RUST_TOOLCHAIN}" bash -c 'echo LLVM_PROFDATA=$RUSTUP_HOME/toolchains/$RUSTUP_TOOLCHAIN/lib/rustlib/$RUST_HOST/bin/llvm-profdata >> "$GITHUB_ENV"'
      shell: bash
      env:
        RUST_TOOLCHAIN: ${{ inputs.rust-toolchain }}

    - name: "Merge pgo data"
      run: ${{ env.LLVM_PROFDATA }} merge -o ${{ github.workspace }}/merged.profdata ${{ github.workspace }}/profdata # zizmor: ignore[github-env, template-injection]
      shell: pwsh  # because it handles paths on windows better, and works well enough on unix for this step

    - name: "Build pgo-optimized wheel"
      uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
      with:
        manylinux: auto
        args: >
          --release
          --out dist
          --interpreter ${{ inputs.interpreter }}
        rust-toolchain: ${{inputs.rust-toolchain}}
        docker-options: -e CI
      env:
        RUSTFLAGS: "-Cprofile-use=${{ github.workspace }}/merged.profdata"

    - name: "Find built wheel"
      id: find_wheel
      run: |
        wheels=$(ls dist/*.whl | tr '\n' ' ')  
        echo "path=$wheels" >> "$GITHUB_OUTPUT"
      shell: bash
